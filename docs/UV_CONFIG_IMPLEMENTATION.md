# UV 配置文件实现文档

## 概述

本文档描述了 BuildFly venv 模块中新增的 UV 配置文件功能，包括自动创建 `uv.toml` 文件和设置 `UV_ENV_FILE` 环境变量。

## 功能特性

### 1. 自动创建 UV 配置文件

- **触发时机**: 在执行 `buildfly venv init` 时自动检查并创建
- **文件位置**: `.buildfly/uv.toml`
- **文件内容**: 包含 PyPI 索引配置和开发依赖

### 2. 环境变量设置

- **环境变量名**: `UV_ENV_FILE`
- **设置时机**: 所有 UV 命令执行时自动设置
- **影响范围**: 虚拟环境创建、Python 包安装、工具安装等

## 实现细节

### 文件创建逻辑

```go
func (m *Manager) createUVConfig() error {
    // 获取 .buildfly 目录路径
    buildflyDir := filepath.Dir(m.rootDir)
    uvConfigPath := filepath.Join(buildflyDir, "uv.toml")

    // 检查文件是否已存在
    if _, err := os.Stat(uvConfigPath); err == nil {
        fmt.Printf("UV config file already exists: %s\n", uvConfigPath)
        return nil
    }

    // 创建默认的 UV 配置内容
    uvConfigContent := fmt.Sprintf(`# BuildFly UV Configuration
# Generated by buildfly venv init

[pypi]
index = "%s"

[tool.uv]
dev-dependencies = [
%s]
`, m.getDefaultIndexURL(), m.getDefaultDependencies())

    // 确保 .buildfly 目录存在
    if err := os.MkdirAll(buildflyDir, 0755); err != nil {
        return fmt.Errorf("failed to create .buildfly directory: %w", err)
    }

    // 写入配置文件
    if err := os.WriteFile(uvConfigPath, []byte(uvConfigContent), 0644); err != nil {
        return fmt.Errorf("failed to write UV config file: %w", err)
    }

    fmt.Printf("Created UV config file: %s\n", uvConfigPath)
    return nil
}
```

### 环境变量设置逻辑

在所有 UV 命令执行前，都会检查并设置 `UV_ENV_FILE` 环境变量：

```go
// 添加 UV_ENV_FILE 环境变量
uvConfigPath := m.getUVConfigPath()
if _, err := os.Stat(uvConfigPath); err == nil {
    env = append(env, fmt.Sprintf("UV_ENV_FILE=%s", uvConfigPath))
}
```

## 配置文件格式

生成的 `uv.toml` 文件格式如下：

```toml
# BuildFly UV Configuration
# Generated by buildfly venv init

[pypi]
index = "https://pypi.org/simple/"

[tool.uv]
dev-dependencies = [
    "cmake",
    "ninja",
    "cmake==3.28.0",
    "ninja==1.11.1",
]
```

## 支持的命令

以下命令会自动使用 UV 配置文件：

1. `buildfly venv init` - 创建配置文件
2. `buildfly venv run` - 运行命令时使用配置
3. `buildfly run` - 在虚拟环境中运行命令
4. 所有 Python 包安装操作
5. 所有 C++ 工具安装操作

## 测试验证

可以使用提供的测试脚本验证功能：

```bash
cd examples/venv-demo
./test-uv-config.sh
```

测试脚本会：
1. 创建临时测试项目
2. 运行 `buildfly venv init`
3. 验证 `uv.toml` 文件创建
4. 测试环境变量设置
5. 验证 UV 命令执行

## 配置自定义

### 自定义 PyPI 索引

在 `buildfly.yaml` 中配置：

```yaml
venv:
  uv:
    index_url: "https://custom.pypi.org/simple/"
```

### 自定义依赖包

在 `buildfly.yaml` 中配置：

```yaml
venv:
  python:
    packages: ["custom-package", "another-package"]
  cpp_tools:
    cmake:
      version: "3.29.0"
      enabled: true
```

## 错误处理

1. **文件已存在**: 如果 `uv.toml` 已存在，不会覆盖，直接使用现有文件
2. **目录创建失败**: 如果无法创建 `.buildfly` 目录，返回错误
3. **文件写入失败**: 如果无法写入配置文件，返回错误
4. **环境变量设置**: 如果配置文件不存在，不会设置环境变量

## 兼容性

- **向后兼容**: 现有项目不受影响，只有在初始化新环境时才会创建配置文件
- **UV 版本**: 兼容 UV 0.8.0+ 版本
- **平台支持**: 支持 Linux、macOS 和 Windows

## 最佳实践

1. **版本控制**: 建议将 `uv.toml` 文件纳入版本控制
2. **团队协作**: 统一团队的 PyPI 索引配置
3. **私有源**: 使用企业内部 PyPI 源时，建议配置自定义索引
4. **依赖管理**: 定期更新依赖包版本

## 故障排除

### 常见问题

1. **配置文件未生效**
   - 检查文件路径是否正确
   - 验证环境变量 `UV_ENV_FILE` 是否设置
   - 确认 UV 命令是否支持配置文件

2. **依赖安装失败**
   - 检查 PyPI 索引 URL 是否可访问
   - 验证依赖包名称和版本是否正确
   - 查看网络连接和代理设置

3. **权限问题**
   - 确保对 `.buildfly` 目录有写权限
   - 检查 UV 工具的执行权限

### 调试方法

1. 使用 `--verbose` 参数查看详细输出
2. 检查环境变量设置：`echo $UV_ENV_FILE`
3. 手动验证配置文件：`uv --help` 查看配置文件选项
4. 查看 UV 官方文档了解配置文件格式

## 更新日志

- **v0.1.0**: 初始实现，支持自动创建 `uv.toml` 文件和环境变量设置
